---
title: "R for data science"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# ################################# Part 1. Explore ##########################

```{r}
install.packages("tidyverse")
library(tidyverse)
install.packages(c("nycflights13", "gapminder", "Lahman"))
```


# ###### 1. Data Visualization with ggplot2

```{r}
library(tidyverse)
mpg
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy, color = class))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy, size = class))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy, alpha = class))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy), color = "blue")
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy)) + facet_wrap( ~ class, nrow = 2)
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy)) + facet_grid(drv ~ cyl)
```

```{r}
ggplot(data = mpg) + geom_smooth(mapping = aes(x = displ, y = hwy))
```

```{r}
ggplot(data = mpg) + geom_smooth(mapping = aes(x = displ, y = hwy, linetype = drv))
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy, color = drv)) + geom_smooth(mapping = aes(x = displ, y = hwy, linetype = drv, color = drv))
```

```{r}
ggplot(data = mpg) + geom_smooth(mapping = aes(displ, y = hwy))
```

```{r}
ggplot(data = mpg) + geom_smooth(mapping = aes(x = displ, y = hwy, group = drv))
```

```{r}
ggplot(data = mpg) + geom_smooth(mapping = aes(x = displ, y = hwy, color = drv), show.legend = FALSE)
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy)) + geom_smooth(mapping = aes(x = displ, y = hwy))
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + geom_point() + geom_smooth()
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + geom_point(mapping = aes(color = class)) + geom_smooth()
```

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + geom_point(mapping = aes(color = class)) + geom_smooth(data = filter(mpg, class == "subcompact"), se = FALSE)
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut))
```

```{r}
ggplot(data = diamonds) + stat_count(mapping = aes(x = cut))
```

```{r}
demo <- tribble(~a, ~b, 
                "bar_1", 20,
                "bar_2", 30,
                "bar_3", 40)
ggplot(data = demo) + geom_bar(mapping = aes(x = a, y = b), stat = 'identity')
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, y = ..prop.., group = 1))
```

```{r}
ggplot(data = diamonds) + stat_summary(mapping = aes(x = cut, y = depth), 
                                       fun.ymin = min, fun.ymax = max,
                                       fun.y = median)
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, color = cut))
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, fill = cut))
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, fill = clarity))
```

```{r}
ggplot(data = diamonds, mapping = aes(x = cut, fill = clarity)) + 
  geom_bar(alpha = 1/5, position = "identity")
```

```{r}
ggplot(data = diamonds, mapping = aes(x = cut, color = clarity)) + 
  geom_bar(fill = NA, position = "identity")
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, fill = clarity), position = "fill")
```

```{r}
ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, fill = clarity), position = "dodge")
```

```{r}
ggplot(data = mpg) + geom_point(mapping = aes(x = displ, y = hwy), position = "jitter")
```

```{r}
ggplot(data = mpg, mapping = aes(x = class, y = hwy)) + geom_boxplot()
```

```{r}
ggplot(data = mpg, mapping = aes(x = class, y = hwy)) + geom_boxplot() + coord_flip()
```

```{r}
nz <- map_data("nz")
ggplot(nz, aes(long, lat, group = group)) + 
  geom_polygon(fill = "white", color = "black")
```

```{r}
ggplot(nz, aes(long, lat, group = group)) + 
  geom_polygon(fill = "white", color = "black") + 
  coord_quickmap()
```

```{r}
bar <- ggplot(data = diamonds) + geom_bar(mapping = aes(x = cut, fill = cut),
                                          show.legend = FALSE,
                                          width = 1) + theme(aspect.ratio = 1) + labs(x = NULL, y = NULL)

bar + coord_flip()
bar + coord_polar()
```


# ###### 2. Workflow: Basic 

```{r}
seq(1,10)
```

```{r}
(y <- seq(1,10,length.out = 5))
```

# ###### 3. Data transformation with dplyr 

```{r}
library(nycflights13)
library(tidyverse)
```

```{r}
flights
```

```{r}
class(flights)
```

```{r}
filter(flights, month == 1, day == 1)
```

```{r}
jan1 <- filter(flights, month == 1, day == 1)
(dec25 <- filter(flights, month == 12, day == 25))
```

```{r}
filter(flights, month == 11 | month == 12)
```

```{r}
nov_dec <- filter(flights, month %in% c(11,12))
```

```{r}
filter(flights, !(arr_delay < 120 | dep_delay > 120))
```

```{r}
filter(flights, arr_delay <= 120, dep_delay <= 120)
```

```{r}
x = NA
is.na(x)
```

```{r}
# filter only includes rows where the condition is TRUE, it excludes both FALSE and NA values. 
df <- tibble(x = c(1,NA,3))
filter(df, x > 1)
```

```{r}
filter(df, is.na(x) | x > 1)
```

```{r}
arrange(flights, year, month, day)
```

```{r}
arrange(flights, desc(arr_delay))
```

```{r}
# missing values are always sorted at the end 
df <- tibble(x = c(5,2,NA))
arrange(df, x)
```

```{r}
select(flights, year, month, day)
```

```{r}
select(flights, year:day)
```

```{r}
select(flights, -(year:day))
```

```{r}
rename(flights, tail_num = tailnum)
```

```{r}
select(flights, time_hour, air_time, everything())
```

```{r}
flights_sml <- select(flights, 
                      year:day,
                      ends_with("delay"),
                      distance, 
                      air_time)
mutate(flights_sml,
       gain = arr_delay - dep_delay,
       speed = distance / air_time * 60)
```

```{r}
mutate(flights_sml,
       gain = arr_delay - dep_delay,
       hours = air_time / 60,
       gain_per_hour = gain / hours)
```

```{r}
transmute(flights, 
          gain = arr_delay - dep_delay,
          hours = air_time / 60,
          gain_per_hour = gain / hours)
```

```{r}
transmute(flights,
          dep_time, 
          hour = dep_time %/% 100,
          minute = dep_time %% 100)
```



```{r}
x <- 1:10
lag(x)
lead(x)
```

```{r}
cumsum(x)
cummean(x)
```

```{r}
v <- c(1, 2, 2, NA, 3, 4)
min_rank(y)
min_rank(desc(y))
```

```{r}
row_number(y)
dense_rank(y)
percent_rank(y)
cume_dist(y)
```

```{r}
summarize(flights, delay = mean(dep_delay, na.rm = TRUE))
```

```{r}
by_day <- group_by(flights, year, month, day)
summarize(by_day, delay = mean(dep_delay, na.rm = TRUE))
```

```{r}
by_test <- group_by(flights, dest)
delay <- summarize(by_dest,
                   count = n(),
                   dist = mean(distance, na.rm = TRUE),
                   delay = mean(arr_delay, na.rm = TRUE))
delay <- filter(delay, count > 20, dest != "HNL")
```

```{r}
ggplot(data = delay, mapping = aes(x = dist, y = delay)) + 
  geom_point(aes(size = count), alpha = 1/3) + 
  geom_smooth(se = FALSE)
```

```{r}
delays <- flights %>% 
          group_by(dest) %>%
          summarize(count = n(),
                    dist = mean(distance, na.rm = TRUE),
                    delay = mean(arr_delay, na.rm = TRUE)) %>% 
          filter(count > 20, dest != "HNL")
```

```{r}
?ggvis
```

```{r}
flights %>% group_by(year, month, day) %>% 
            summarize(mean = mean(dep_delay))
```

```{r}
flights %>% 
        group_by(year, month, day) %>%
        summarize(mean = mean(dep_delay, na.rm = TRUE))
```

```{r}
not_cancelled <- flights %>% 
                         filter(!is.na(dep_delay), !is.na(arr_delay))
```

```{r}
not_cancelled %>% 
              group_by(year, month, day) %>% 
              summarize(mean = mean(dep_delay))
```

```{r}
delays <- not_cancelled %>% 
                        group_by(tailnum) %>% 
                        summarize(delay = mean(arr_delay))
ggplot(data = delays, mapping = aes(x = delay)) +
  geom_freqpoly(binwidth = 10)
```

```{r}
delays <- not_cancelled %>% 
                        group_by(tailnum) %>% 
                        summarize(delay = mean(arr_delay, na.rm = TRUE),
                                  n = n())
ggplot(data = delays, mapping = aes(x = n, y = delay)) + 
  geom_point(alpha = 1/10)
```

```{r}
delays %>% 
  filter(n > 25) %>% 
  ggplot(mapping = aes(x = n, y = delay)) + 
  geom_point(alpha = 1/10)
```

```{r}
batting <- as_tibble(Lahman::Batting)

batters <- batting %>% 
  group_by(playerID) %>% 
  summarize(ba = sum(H, na.rm = TRUE) / sum(AB, na.rm = TRUE),
            ab = sum(AB, na.rm = TRUE))

batters %>% 
  filter(ab > 100) %>% 
  ggplot(mapping = aes(x = ab, y = ba)) + 
  geom_point() + 
  geom_smooth(se = FALSE)
```

```{r}
batters %>% arrange(desc(ba))
```

```{r}
not_cancelled %>% 
  group_by(year, month, day) %>% 
  summarize(avg_delay1 = mean(arr_delay),
            avg_delay2 = mean(arr_delay[arr_delay > 0]))
```

```{r}
not_cancelled %>% 
  group_by(dest) %>% 
  summarize(distance_sd = sd(distance)) %>% 
  arrange(desc(distance_sd))
```

```{r}
not_cancelled %>% 
  group_by(year, month, day) %>% 
  summarize(first = min(dep_time),
            last = max(dep_time))
```

```{r}
not_cancelled %>% 
  group_by(year, month, day) %>% 
  summarize(first_dep = first(dep_time),
            last_dep = last(dep_time))
```

```{r}
not_cancelled %>% 
  group_by(year, month, day) %>% 
  mutate(r = min_rank(desc(dep_time))) %>% 
  filter(r %in% range(r))
```

```{r}
not_cancelled %>% 
  group_by(dest) %>% 
  summarize(carriers = n_distinct(carrier)) %>% 
  arrange(desc(carriers))
```

```{r}
not_cancelled %>% 
  count(dest)
```

```{r}
not_cancelled %>% 
  count(tailnum, wt = distance)
```

```{r}
not_cancelled %>%
  group_by(year, month, day) %>% 
  summarize(n_early = sum(dep_time < 500))
```

```{r}
not_cancelled %>% 
  group_by(year, month, day) %>% 
  summarize(hour_perc = mean(arr_delay > 60))
```

```{r}
daily <- group_by(flights, year, month, day)
(per_day <- summarize(daily, flights = n()))
```

```{r}
(per_month <- summarize(per_day, flights = sum(flights)))
```

```{r}
(per_year <- summarize(per_month, flights = sum(flights)))
```

```{r}
daily %>% 
  ungroup() %>% 
  summarize(flights = n())
```

```{r}
flights_sml %>% 
  group_by(year, month, day) %>% 
  filter(rank(desc(arr_delay))<10)
```

```{r}
popular_dests <- flights %>%
  group_by(dest) %>%
  filter(n()>365)
popular_dests
```

```{r}
popular_dests %>%
  filter(arr_delay > 0) %>%
  mutate(prop_delay = arr_delay / sum(arr_delay)) %>%
  select(year:day, dest, arr_delay, prop_delay)
  
```


# ###### 4. Workflow: Scripts 

# ###### 5. Exploratory data analysts

```{r}
library(tidyverse)
```

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut))
```

```{r}
diamonds %>% count(cut)
```

```{r}
ggplot(data = diamonds) + 
  geom_histogram(mapping = aes(x = carat), binwidth = 0.5)
```

```{r}
diamonds %>% 
  count(cut_width(carat, 0.5))
```

```{r}
smaller <- diamonds %>% 
  filter(carat < 3)

ggplot(data = smaller, mapping = aes(x = carat)) + 
  geom_histogram(binwidth = 0.1)
```

```{r}
ggplot(data = smaller, mapping = aes(x = carat, color = cut)) + 
  geom_freqpoly(binwidth = 0.1)
```

```{r}
ggplot(data = smaller, mapping = aes(x = carat)) + geom_histogram(binwidth = 0.01)
```

```{r}
ggplot(data = faithful, mapping = aes(x = eruptions)) + geom_histogram(binwidth = 0.25)
```

```{r}
ggplot(diamonds) + 
  geom_histogram(mapping = aes(x = y), binwidth = 0.5)
```

```{r}
ggplot(diamonds) + 
  geom_histogram(mapping = aes(x = y), binwidth = 0.5) + 
  coord_cartesian(ylim = c(0,50))
```

```{r}
unusuak <- diamonds %>% 
  filter(y < 3 | y > 20) %>% 
  arrange(y)
unusual
```

```{r}
diamonds2 <- diamonds %>% 
  filter(between(y, 3, 20))
```

```{r}
diamonds2 <- diamonds %>% 
  mutate(y = ifelse(y < 3 | y > 20, NA, y))
```

```{r}
ggplot(data = diamonds2, mapping = aes(x = x, y = y)) + 
  geom_point()
```

```{r}
ggplot(data = diamonds2, mapping = aes(x = x, y = y)) + 
  geom_point(na.rm = TRUE)
```

```{r}
nycflights13::flights %>% 
  mutate(cancelled = is.na(dep_time),
         sched_hour = sched_dep_time %/% 100,
         sched_min = sched_dep_time %% 100,
         sched_dep_time = sched_hour + sched_min / 60) %>% 
  ggplot(mapping = aes(sched_dep_time)) + 
  geom_freqpoly(mapping = aes(color = cancelled),
                binwidth = 1/4)
```

```{r}
ggplot(data = diamonds, mapping = aes(x = price)) + 
  geom_freqpoly(mapping = aes(color = cut), binwidth = 500)
```

```{r}
ggplot(diamonds) + 
  geom_bar(mapping = aes(x = cut))
```

```{r}
ggplot(data = diamonds, mapping = aes(x = price, y = ..density..)) + 
  geom_freqpoly(mapping = aes(color = cut), binwidth = 500)
```

```{r}
ggplot(data = diamonds, mapping = aes(x = cut, y = price)) + 
  geom_boxplot()
```

```{r}
ggplot(data = mpg, mapping = aes(x = class, y = hwy)) + 
  geom_boxplot()
```

```{r}
ggplot(data = mpg) + 
  geom_boxplot(mapping = aes(x = reorder(class, hwy, FUN = median),y = hwy))
```

```{r}
ggplot(data = mpg) + 
  geom_boxplot(mapping = aes(x = reorder(class, hwy, FUN = median), y = hwy)) + 
  coord_flip()
```

```{r}
ggplot(data = diamonds) + 
  geom_count(mapping = aes(x = cut, y = color))
```

```{r}
diamonds %>% 
  count(color, cut)
```

```{r}
diamonds %>% 
  count(color, cut) %>% 
  ggplot(mapping = aes(x = color, y = cut)) + 
  geom_tile(mapping = aes(fill = n))
```

```{r}
ggplot(data = diamonds) + 
  geom_point(mapping = aes(x = carat, y = price))
```

```{r}
ggplot(data = diamonds) + 
  geom_point(mapping = aes(x = carat, y = price), alpha = 1/100)
```

```{r}
ggplot(data = smaller) + 
  geom_bin2d(mapping = aes(x = carat, y = price))
```


```{r}
ggplot(data = smaller) + 
  geom_hex(mapping = aes(x = carat, y = price))
```

```{r}
ggplot(data = smaller, mapping = aes(x = carat, y = price)) + 
  geom_boxplot(mapping = aes(group = cut_width(carat, 0.1)))
```

```{r}
ggplot(data = smaller, mapping = aes(x = carat, y = price)) + 
  geom_boxplot(mapping = aes(group = cut_number(carat, 20)))
```

```{r}
ggplot(data = faithful) + 
  geom_point(mapping = aes(x = eruptions, y = waiting))
```

```{r}
library(modelr)
mod <- lm(log(price) ~ log(carat), data = diamonds)

diamonds2 <- diamonds %>% 
  add_residuals(mod) %>% 
  mutate(resid = exp(resid))

ggplot(data = diamonds2) + 
  geom_point(mapping = aes(x = carat, y = resid))
```

```{r}
ggplot(data = diamonds2) + 
  geom_boxplot(mapping = aes(x = cut, y = resid))
```

```{r}
ggplot(data = faithful, mapping = aes(x = eruptions)) + 
  geom_freqpoly(bindwidth = 0.25)
```

```{r}
ggplot(faithful, aes(eruptions)) + 
  geom_freqpoly(binwidth = 0.25)
```

```{r}
diamonds %>% 
  count(cut, clarity) %>%
  ggplot(aes(clarity, cut, fill = n)) + 
  geom_tile()
```

# ###### 6. Workflow: Projects 







# ################################# Part 2. Wrangle ##########################


# ###### 7. Tibbles with tibble

```{r}
library(tidyverse)
```

```{r}
as_tibble(iris)
```

```{r}
tibble(
  x = 1:5,
  y = 1,
  z = x ^ 2 + y
)
```

```{r}
tb <- tibble(
  `:)` = "smile",
  ` ` = "space",
  `2000` = "number"
)
tb
```

```{r}
tribble(
  ~x, ~y, ~z,
  "a",2,3.6,
  "b",1,8.5
)
```

```{r}
tibble(
  a = lubridate::now() + runif(1e3) * 86400,
  b = lubridate::today() + runif(1e3) * 30,
  c = 1:1e3,
  d = runif(1e3),
  e = sample(letters, 1e3, replace = TRUE)
)
```

```{r}
nycflights13::flights %>% print(n = 10, width = Inf)
```

```{r}
# options(tibble.print_max = n, tibble.print_min = m)
# options(tibble.width = Inf)
```

```{r}
df <- tibble(
  x = runif(5),
  y = rnorm(5)
)
```

```{r}
df$x
```

```{r}
df[["x"]]
```

```{r}
df["x"]
```

```{r}
df[[1]]
```

```{r}
df[1]
```

```{r}
df %>% .$x
```

```{r}
df %>% .[["x"]]
```

```{r}
class(as.data.frame(tb))
```

# ###### 8. Data import with readr 

```{r}
library(tidyverse)
```

```{r}
# read_csv(), read_csv2(), read_tsv(), read_delim(), read_fwf(), read_log()
```

```{r}
heights <- read_csv("data/heights.csv")
```

```{r}
read_csv("a,b,c
         1,2,3
         4,5,6")
```

```{r}
read_csv("The first line of metadata
         The second line of metadata
         x,y,z
         1,2,3", skip = 2)
```

```{r}
read_csv("# A comment I want to skip
         x,y,z
         1,2,3", comment = "#")
```

```{r}
read_csv("1,2,3\n4,5,6", col_names = FALSE)
```

```{r}
read_csv("1,2,3\n4,5,6", col_names = c("x","y","z"))
```

```{r}
read_csv("a,b,c\n1,2,.",na = ".")
```

```{r}
# compared to base R, faster, have progress bar, produce tibbles, don't convert character vectors to facors, use row names, reproducible
```

```{r}
str(parse_logical(c("TRUE","FALSE","NA")))
```

```{r}
str(parse_integer(c("1","2","3")))
```

```{r}
str(parse_date(c("2010-01-01","1979-10-14")))
```

```{r}
parse_integer(c("1","231",".","456"), na=".")
```

```{r}
x <- parse_integer(c("123","345","abc","123.45"))
```

```{r}
x
```

```{r}
problems(x)
```

```{r}
parse_double("1.23")
```

```{r}
parse_double("1,23", locale = locale(decimal_mark = ","))
```

```{r}
parse_number("$100")
parse_number("20%")
parse_number("It cost $123.45")
```

```{r}
parse_number("$123,456,789")
parse_number("123.456.789", locale = locale(grouping_mark = "."))
parse_number("123`456`789", locale = locale(grouping_mark = "`"))
```

```{r}
charToRaw("Hadley")
```

```{r}
x1 <- "El Ni\xf1o was particularly bad this year"
x2 <- "\x82\xb1\x82\xf1\x82\xc9\x82\xbf\x82\xcd"
```

```{r}
parse_character(x1, locale = locale(encoding = "Latin1"))
parse_character(x2, locale = locale(encoding = "Shift-JIS"))
```

```{r}
guess_encoding(charToRaw(x1))
```

```{r}
guess_encoding(charToRaw(x2))
```

```{r}
fruit <- c("apple", "banana")
parse_factor(c("apple","banana","bananana"), levels = fruit)
```

```{r}
parse_datetime("2010-10-01T2010")
parse_datetime("20101010")
```

```{r}
parse_date("2010-10-01")
```

```{r}
library(hms)
parse_time("01:10 am")
parse_time("20:10:01")
```

```{r}
parse_date("01/02/15","%m/%d/%y")
parse_date("01/02/15","%d/%m/%y")
parse_date("01/02/15","%y/%m/%d")
```

```{r}
parse_date("1 janvier 2015", "%d %B %Y", locale = locale("fr"))
```

```{r}
guess_parser("2010-10-01")
guess_parser("15:01")
guess_parser(c("TRUE", "FALSE"))
guess_parser(c("1","5","9"))
guess_parser(c("12, 352, 561"))
str(parse_guess("2010-10-10"))
```

```{r}
challenge <- read_csv(readr_example("challenge.csv"))
```

```{r}
problems(challenge)
```

```{r}
challenge <- read_csv(readr_example("challenge.csv"),
                      col_types = cols(
                        x = col_integer(),
                        y = col_character()
                      ))
```

```{r}
challenge <- read_csv(
  readr_example("challenge.csv"),
  col_types = cols(
    x = col_double(),
    y = col_character()
  )
)
```

```{r}
tail(challenge)
```

```{r}
challenge <- read_csv(
  readr_example("challenge.csv"),
  col_type = cols(
    x = col_double(),
    y = col_date()
  )
)
```

```{r}
tail(challenge)
```

```{r}
challenge2 <- read_csv(
  readr_example("challenge.csv"),
  guess_max = 1001
)
challenge2
```

```{r}
challenge2 <- read_csv(readr_example("challenge.csv"),
                       col_types = cols(.default = col_character()))
```

```{r}
df <- tribble(
  ~x, ~y,
  "1", "1.21",
  "2", "2.32",
  "3", "4.56"
)
df
```

```{r}
type_convert(df)
```

```{r}
write_csv(challenge,"challenge.csv")
```

```{r}
challenge
write_csv(challenge, "challenge-2.csv")
read_csv("challenge-2.csv")
```

```{r}
write_rds(challenge, "challenge.rds")
read_rds("challenge.rds")
```

```{r}
library(feather)
write_feather(challenge, "challenge.feather")
read_feather("challenge.feather")
```


# ###### 9. Tidy data with tidyr 

```{r}
table1
```

```{r}
table2
```

```{r}
table3
```

```{r}
table4a
```

```{r}
table4b
```

```{r}
table1 %>% 
  mutate(rate = cases / population * 10000)
```

```{r}
table1 %>%
  count(year, wt = cases)
```

```{r}
library(ggplot2)
ggplot(table1, aes(year, cases)) + 
  geom_line(aes(group = country), color = "grey50") + 
  geom_point(aes(color = country))
```

```{r}
table4a
```

```{r}
table4a %>%
  gather(`1999`,`2000`,key = "year", value = "cases")
```

```{r}
table4b
```

```{r}
table4b %>% 
  gather(`1999`, `2000`, key = "year", value = "population")
```

```{r}
tidy4a <- table4a %>%
  gather(`1999`, `2000`, key = "year", value = "cases")
tidy4b <- table4b %>%
  gather(`1999`, `2000`, key = "year", value = "population")
left_join(tidy4a, tidy4b)
```

```{r}
table2
```

```{r}
spread(table2, key = type, value = count)
```

```{r}
table3
```

```{r}
table3 %>% 
  separate(rate, into = c("cases", "population"))
```

```{r}
table3 %>%
  separate(rate, into = c("cases", "population"), sep = "/")
```

```{r}
table3 %>%
  separate(
    rate, 
    into = c("cases","population"),
    convert = TRUE
  )
```

```{r}
table5
```

```{r}
table5 %>% 
  unite(new, century, year)
```

```{r}
table5 %>%
  unite(new, century, year, sep = "")
```

```{r}
stocks <- tibble(
  year = c(2015, 2015, 2015, 2015, 2016, 2016, 2016),
  qtr = c(1, 2, 3, 4, 2, 3, 4),
  return = c(1.88, 0.59, 0.35, NA, 0.92, 0.17, 2.66)
)
stocks
```

```{r}
stocks %>% 
  spread(year, return)
```

```{r}
stocks %>%
  spread(year, return) %>% 
  gather(year, return, `2015`, `2016`, na.rm = TRUE)
```

```{r}
stocks %>% 
  complete(year, qtr)
```

```{r}
treatment <- tribble(
  ~ person, ~ treatment, ~ response,
  "Derrick Whitmore", 1, 7,
  NA, 2, 10,
  NA, 3, 9,
  "Katherine Burke", 1, 4
)
treatment
```

```{r}
treatment %>%
  fill(person)
```

```{r}
who
```

```{r}
who1 <- who %>% 
  gather(new_sp_m014:newrel_f65, 
         key = "key", 
         value = "cases",
         na.rm = TRUE)
who1
```

```{r}
who1 %>%
  count(key)
```

```{r}
who2 <- who1 %>% 
  mutate(key = stringr::str_replace(key, "newrel", "new_rel"))
who2
```
```{r}
who3 <- who2 %>% 
  separate(key, c("new", "type", "sexage"), sep = "_")
who3
```

```{r}
who3 %>% 
  count(new)
```

```{r}
who4 <- who3 %>%
  select(-new, -iso2, -iso3)
```

```{r}
who5 <- who4 %>%
  separate(sexage, c("sex","age"),sep = 1)
who5
```

```{r}
who %>% 
  gather(code, value, new_sp_m014:newrel_f65, na.rm = TRUE) %>% 
  mutate(code = stringr::str_replace(code, "newrel", "new_rel")) %>% 
  separate(code, c("new", "var", "sexage")) %>%
  select(-new, -iso2, -iso3) %>% 
  separate(sexage, c("sex", "age"), sep = 1)
```


# ###### 10. Relational data with dplyr 

```{r}
library(tidyverse)
library(nycflights13)
```

```{r}
airlines
```

```{r}
airports
```

```{r}
planes
```

```{r}
weather
```

```{r}
planes %>% 
  count(tailnum) %>% 
  filter(n > 1)
```

```{r}
weather %>% 
  count(year, month, day, hour, origin) %>% 
  filter(n > 1)
```

```{r}
flights %>% 
  count(year, month, day, flight) %>% 
  filter(n > 1)
```

```{r}
flights %>% 
  count(year, month, day, tailnum) %>% 
  filter(n > 1)
```

```{r}
flights2 <- flights %>% 
  select(year:day, hour, origin, dest, tailnum, carrier)
flights2
```

```{r}
flights2 %>% 
  select(-origin, -dest) %>% 
  left_join(airlines, by = "carrier")
```

```{r}
flights2 %>% 
  select(-origin, -dest) %>% 
  mutate(name = airlines$name[match(carrier, airlines$carrier)])
```

```{r}
x <- tribble(
  ~ key, ~val_X,
  1, "x1",
  2, "x2",
  3, "x3"
)
```

```{r}
y <- tribble(
  ~ key, ~ val_y,
  1, "y1",
  2, "y2",
  4, "y3"
)
```

```{r}
x %>% 
  inner_join(y, by = "key")
```

```{r}
x <- tribble(
  ~ key, ~val_x,
  1, "x1",
  2, "x2",
  2, "x3",
  1, "x4"
)
```

```{r}
y <- tribble(
  ~ key, ~val_y,
  1, "y1",
  2, "y2"
)
```

```{r}
left_join(x, y, by = "key")
```

```{r}
x <- tribble(
  ~key, ~val_x,
  1, "x1",
  2, "x2",
  2, "x3",
  3, "x4"
)
y <- tribble(
  ~key, ~val_y,
  1, "y1",
  2, "y2",
  2, "y3",
  3, "y4"
)
left_join(x, y, by = "key")
```

```{r}
flights2 %>% 
  left_join(weather)
```

```{r}
flights2 %>% 
  left_join(planes, by = "tailnum")
```

```{r}
flights2 %>%
  left_join(airports, c("dest" = "faa"))
```

```{r}
flights2 %>% 
  left_join(airports, c("origin" = "faa"))
```

```{r}
top_dest <- flights %>% 
  count(dest, sort = TRUE) %>% 
  head(10)
top_dest
```

```{r}
flights %>% 
  filter(dest %in% top_dest$dest)
```

```{r}
flights %>% 
  semi_join(top_dest)
```

```{r}
flights %>% 
  anti_join(planes, by = "tailnum") %>% 
  count(tailnum, sort = TRUE)
```

```{r}
airports %>% 
  count(alt, lon) %>% 
  filter(n>1)
```

```{r}
df1 <- tribble(
  ~x, ~y,
  1, 1,
  2, 1
)
df2 <- tribble(
  ~x, ~y,
  1, 1, 
  1, 2
)
```

```{r}
intersect(df1, df2)
```

```{r}
union(df1, df2)
```

```{r}
setdiff(df1, df2)
```

```{r}
setdiff(df2, df1)
```



# ###### 11. Strings with stringr 

```{r}
library(tidyverse)
library(stringr)
```

```{r}
string1 <- "This is a string"
string2 <- 'To put a "quote" inside a string, use single quotes'
```

```{r}
double_quote <- "\"" # or '"'
single_quote <- '\'' # or "'"
```

```{r}
x <- c("\"", "\\")
x
writeLines(x)
```

```{r}
x <- "\u00b5"
x
```

```{r}
c("one", "two", "three")
```

```{r}
str_length(c("a","R for data science", NA))
```

```{r}
str_c("x", "y")
str_c("x","y","z")
```

```{r}
str_c("x","y",sep=", ")
```

```{r}
x <- c("abc", NA)
str_c("|-", str_replace_na(x), "-|")
```

```{r}
str_c("prefix-", c("a","b","c"),"-suffix")
```

```{r}
name <- "Hadley"
time_of_day <- "mornig"
birthday <- FALSE

str_c("Good ", time_of_day, " ", name, 
      if(birthday)" and HAPPY BIRTHDAY", ".")
```

```{r}
str_c(c("x","y","z"), collapse = ", ")
```

```{r}
x <- c("Apple", "Banana", "Pear")
str_sub(x, 1, 3)
str_sub(x, -3, -1)
```

```{r}
str_sub("a",1,5)
```

```{r}
str_sub(x,1,1) <- str_to_lower(str_sub(x,1,1))
x
```

```{r}
str_to_upper(c("i","ı"))
str_to_upper(c("i", "ı"), locale = "tr")
```

```{r}
x <- c("apple", "eggplant","banana")
str_sort(x, locale = "en")
str_sort(x, locale = "haw")
```

```{r}
x <- c("apple", "banana", "pear")
str_view(x, "an")
```

```{r}
str_view(x, ".a.")
```

```{r}
dot <- "\\."
writeLines(dot)
str_view(c("abc","a.c","bef"),"a\\.c")
```

```{r}
x <- "a\\b"
writeLines(x)
str_view(x, "\\\\")
```

```{r}
x <- c("apple", "banana", "pear")
str_view(x, "^a")
str_view(x, "a$")
```

```{r}
x <- c("apple pie","apple","apple cake")
str_view(x, "apple")
str_view(x, "^apple$")
```

```{r}
str_view(c("grey","gray"),"gr(e|a)y")
```

```{r}
x <- "1888 is the longest year in Roman numerals: MDCCCLXXXVIII"
str_view(x, "CC?")
str_view(x, "CC+")
str_view(x, "C[LX]+")
```

```{r}
str_view(x, "C{2}")
str_view(x, "C{2,}")
str_view(x, "C{2,3}")
```

```{r}
str_view(x, "C{2,3}?")
str_view(x, "C[LX]+?")
```

```{r}
str_view(fruit, "(..)\\1", match = TRUE)
```

```{r}
x <- c("apple","banana","pear")
str_detect(x, "e")
```

```{r}
sum(str_detect(words, "^t"))
mean(str_detect(words, "[aeiou]$"))
```

```{r}
no_vowels_1 <- !str_detect(words, "[aeiou]")
no_vowels_2 <- str_detect(words, "^[^aeiou]+$")
identical(no_vowels_1, no_vowels_2)
```

```{r}
words[str_detect(words,"x$")]
str_subset(words, "x$")
```

```{r}
df <- tibble(
  word = words,
  i = seq_along(word)
)
df
```


```{r}
df %>% 
  filter(str_detect(words, "x$"))
```


```{r}
x <- c("apple", "banana", "pear")
str_count(x, "a")
```

```{r}
mean(str_count(words, "[aeiou]"))
```

```{r}
df %>% 
  mutate(
    vowels = str_count(word, "[aeiou]"),
    consonants = str_count(word, "[^aeiou]")
  )
```

```{r}
str_count("abababa","aba")
str_view_all("abababa","aba")
```

```{r}
length(sentences)
head(sentences)
```

```{r}
colors <- c("red", "orange", "yellow", "green", "blue", "purple")
color_match <- str_c(colors, collapse = "|")
color_match
```

```{r}
has_color <- str_subset(sentences, color_match)
matches <- str_extract(has_color, color_match)
head(matches)
```

```{r}
more <- sentences[str_count(sentences, color_match)>1]
str_view_all(more, color_match)
```

```{r}
str_extract(more, color_match)
```

```{r}
str_extract_all(more, color_match)
```

```{r}
str_extract_all(more, color_match, simplify = TRUE)
```

```{r}
x <- c("a","a b","a b c")
str_extract_all(x, "[a-z]", simplify = TRUE)
```

```{r}
noun <- "(a|the) ([^ ]+)"
has_noun <- sentences %>%
  str_subset(noun) %>% 
  head(10)
has_noun %>% 
  str_extract(noun)
```

```{r}
has_noun %>%
  str_match(noun)
```

```{r}
tibble(sentence = sentences) %>% 
  tidyr::extract(
    sentence, c("article","noun"),"(a|the) ([^ ]+)", 
    remove = FALSE
  )
```

```{r}
x <- c("apple", "pear", "banana")
str_replace(x, "[aeiou]", "-")
```

```{r}
x <- c("1 house", "2 cars", "3 people")
str_replace_all(x, c("1" = "one", "2" = "two", "3" = "three"))
```

```{r}
sentences %>% 
  str_replace("([^ ]+) ([^ ]+) ([^ ]+)", "\\1 \\3 \\2") %>% 
  head(5)
```

```{r}
sentences %>%
  head(5) %>%
  str_split(" ")
```

```{r}
"a|b|c|d" %>% 
  str_split("\\|") %>% 
  .[[1]]
```

```{r}
sentences %>%
  head(5) %>%
  str_split(" ", simplify = TRUE)
```

```{r}
fields <- c("Name: Hadley", "Country: NZ", "Age: 35")
fields %>% 
  str_split(": ", n = 2, simplify = TRUE)
```

```{r}
x <- "This is a sentence. This is another sentence."
str_view_all(x, boundary("word"))
```

```{r}
str_split(x, " ")[[1]]
```

```{r}
str_split(x, boundary("word"))[[1]]
```

```{r}
str_view(fruit, "nana")
```

```{r}
str_view(fruit, regex("nana"))
```

```{r}
bananas <- c("banana", "Banana", "BANANA")
str_view(bananas, "banana")
```

```{r}
str_view(bananas, regex("banana", ignore_case = TRUE))
```

```{r}
x <- "Line 1\nLine 2\nLine 3"
str_extract_all(x, "^Line")[[1]]
str_extract_all(x, regex("^Line", multiline = TRUE))[[1]]
```

```{r}
phone <- regex("
    \\(? # optional opening parens
    (\\d{3}) # area code
    [)- ]? # optional closing parens, dash, or space
    (\\d{3}) # another three numbers
    [ -]? # optional space or dash
    (\\d{3}) # three more numbers
    ", comments = TRUE)
str_match("514-791-8141", phone)
```

```{r}
microbenchmark::microbenchmark(
  fixed = str_detect(sentences, fixed("the")),
  regex = str_detect(sentences, "the"),
  times = 20
)
```

```{r}
a1 <- "\u00e1"
a2 <- "a\u0301"
c(a1, a2)
a1 == a2
```

```{r}
str_detect(a1, fixed(a2))
str_detect(a1, coll(a2))
```

```{r}
i <- c("I", "İ", "i", "ı")
i

str_subset(i, coll("i", ignore_case = TRUE))

str_subset(
i,
coll("i", ignore_case = TRUE, locale = "tr")
)
```

```{r}
stringi::stri_locale_info()
```

```{r}
x <- "This is a sentence"
str_view_all(x, boundary("word"))
str_extract_all(x, boundary("word"))
```

```{r}
apropos("replace")
```

```{r}
head(dir(pattern = "\\.Rmd$"))
```



# ###### 12. Factors with forcats 

```{r}

```


# ###### 13. Dates and times with lubridate 


# ################################# Part 3. Program ##########################

# ###### 14. Pipes with magrittr 
# ###### 15. Functions 
# ###### 16. Vectors 
# ###### 17. Iteration with purrr

# ################################# Part 4. Model ##########################

# ###### 18. Model basics with modelr 
# ###### 19. Model building 
# ###### 20. Many models with purrr and broom


# ################################# Part 5. Communicate ######################

# ###### 21. R markdown 
# ###### 22. Graphics for communication with ggplot2 
# ###### 23. R markdown formats 
# ###### 24. R markdown workflow 



















